/*!
 * routrrr - version 0.2.0
 *
 * Made with ❤ by Steve Ottoz so@dev.so
 *
 * Copyright (c) 2016 Steve Ottoz
 */
'use strict';export default class Routrrr{constructor(a=!1,b='#!'){this.support=history&&history.pushState,this.routes=[],this.mw=[],this.currentPath='',this.currentHash='',this.useHash=a,this.hashPrefix=b,['popstate','pushstate','replacestate'].forEach(c=>{window.addEventListener(c,d=>{return!this.useHash&&this.currentPath===d.target.location.pathname&&this.currentPath!==d.target.location.hash&&d.target.location.hash?(d.preventDefault(),!1):void this.load()})})}get(a,b,c){const d={path:a,mw:c?b:null,fn:c||b,keys:[],params:{}};return d.regex=pathToRegex(d.path,d.keys,!1,!1),this.routes.push(d),this}use(a){return /^f/.test(typeof a)&&0>this.mw.indexOf(a)&&this.mw.push(a),this}redirect(a,b){return this.useHash?window.location.hash=this.hashPrefix+a:this.support?(b?history.replaceState:history.pushState)({url:a,date:new Date},null,a):window.location.href=a,this}load(a){const b=this.useHash?location.hash.replace(hashPrefix,''):(a&&a.url?a.url:window.location.pathname).split('?')[0],c={};let f,g,d=Object.assign({},location,{params:c,pathname:b,query:getQueryParams()});return this.routes.forEach(h=>{!f&&(g=b.match(h.regex))&&(f=h)}),f?(g&&g.shift(),g.forEach((h,j)=>{c[f.keys[j].name]=h}),Object.assign(d,{route:f.path,params:c}),callMiddleware.call(this,d).then(()=>{f.mw?f.mw.apply(this,[d]).then(()=>{f.fn.apply(this,[d])}).catch(h=>{}):f.fn.apply(this,[d])}).catch(h=>{})):callMiddleware.call(this,d).then(()=>{Object.assign(d,{route:null}),this.default&&this.default.apply(this,[d])}).catch(h=>{}),this.currentPath=b,this.currentHash=location.hash,this}init(){return this.load()}setDefault(a){return /^f/.test(typeof a)&&(this.default=a),this}}function callMiddleware(a){return new Promise((b,c)=>{const d=[];this.mw.forEach(f=>{d.push(f.apply(this,[a]))}),Promise.all(d).then(b).catch(c)})}function pathToRegex(a,b,c,d){return a instanceof RegExp?a:(a instanceof Array&&(a='('+a.join('|')+')'),a=a.concat(d?'':'/?').replace(/\/\(/g,'(?:/').replace(/\+/g,'__plus__').replace(/(\/)?(\.)?:(\w+)(?:(\(.*?\)))?(\?)?/g,function(f,g,h,j,k,l){return b.push({name:j,optional:!!l}),g=g,''+(l?'':g)+'(?:'+(l?g:'')+h+(k||h&&'([^/.]+?)'||'([^/]+?)')+')'+l}).replace(/([\/.])/g,'\\$1').replace(/__plus__/g,'(.+)').replace(/\*/g,'(.*)'),new RegExp('^'+a+'$',c?'':'i'))}function getQueryParams(a){if(a=location.search.replace('?','')){const b=a.split('&'),c={},d=/\[\]$/;for(let f of b){let[g,h]=decodeURIComponent(f).split('=');h=h?h.split('+').join(' '):'',d.test(g)?(g=g.replace(d,''),!Array.isArray(c[g])&&(c[g]=[]),c[g]=[...c[g],h]):c[g]=h}return c}};(function(a){'use strict';function b(f,g){const h=document.createEvent('CustomEvent');h.initCustomEvent(f+'state',!0,!0,g),window.dispatchEvent(h)}if(!a&&!a.pushState)return!1;const c=a.pushState,d=a.replaceState;a.pushState=function(f,g){let h=c.apply(a,arguments);return g&&(document.title=g),b('push',f),h},a.replaceState=function(f,g){let h=d.apply(a,arguments);return g&&(document.title=g),b('replace',f),h}})(window.history);